' Code Generated by Sidekick is for learning and experimentation purposes only.
Sub ConsolidateExcelFiles_WithErrorLog_AndPivots()
    Dim folderPath As String
    Dim fileName As String
    Dim wbSource As Workbook
    Dim wsSource As Worksheet
    Dim wbDest As Workbook
    Dim wsDest As Worksheet
    Dim wsLog As Worksheet
    Dim wsPivot As Worksheet
    Dim lastRowDest As Long
    Dim lastRowLog As Long
    Dim i As Long
    Dim caseID As String
    Dim description As String
    Dim timeTaken As Variant
    Dim errorMsg As String

    ' Prompt user to select folder
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with Excel Files"
        If .Show = -1 Then
            folderPath = .SelectedItems(1) & "\"
        Else
            Exit Sub
        End If
    End With

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Create new workbook for consolidation
    Set wbDest = Workbooks.Add
    Set wsDest = wbDest.Sheets(1)
    wsDest.Name = "Consolidated"
    ' Add headers to consolidated sheet
    wsDest.Range("A1:C1").Value = Array("Case ID", "Description", "Time taken")
    lastRowDest = 2

    ' Add error log sheet
    Set wsLog = wbDest.Sheets.Add(After:=wsDest)
    wsLog.Name = "Error Log"
    wsLog.Range("A1:B1").Value = Array("File Name", "Error Description")
    lastRowLog = 2

    ' Loop through all .xlsx files in the folder
    fileName = Dir(folderPath & "*.xlsx")
    Do While fileName <> ""
        If Left(fileName, 2) <> "~$" Then
            errorMsg = ""
            On Error GoTo FileOpenError
            Set wbSource = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
            Set wsSource = wbSource.Sheets(1) ' Always Sheet1
            On Error GoTo 0

            caseID = wsSource.Range("B1").Value
            If Trim(caseID) = "" Then
                wsLog.Cells(lastRowLog, 1).Value = fileName
                wsLog.Cells(lastRowLog, 2).Value = "Missing Case ID in B1"
                lastRowLog = lastRowLog + 1
            End If

            For i = 4 To 27 ' F4:F27
                On Error Resume Next
                timeTaken = wsSource.Cells(i, 6).Value ' Column F
                If Err.Number <> 0 Then
                    wsLog.Cells(lastRowLog, 1).Value = fileName
                    wsLog.Cells(lastRowLog, 2).Value = "Error reading cell F" & i
                    lastRowLog = lastRowLog + 1
                    Err.Clear
                    On Error GoTo 0
                Else
                    On Error GoTo 0
                    If IsNumeric(timeTaken) And timeTaken > 0 And Trim(caseID) <> "" Then
                        description = wsSource.Cells(i, 1).Value ' Column A
                        wsDest.Cells(lastRowDest, 1).Value = caseID
                        wsDest.Cells(lastRowDest, 2).Value = description
                        wsDest.Cells(lastRowDest, 3).Value = timeTaken
                        lastRowDest = lastRowDest + 1
                    End If
                End If
            Next i

            wbSource.Close SaveChanges:=False
        End If
        fileName = Dir
        GoTo ContinueLoop

FileOpenError:
        wsLog.Cells(lastRowLog, 1).Value = fileName
        wsLog.Cells(lastRowLog, 2).Value = "Could not open file or missing Sheet1"
        lastRowLog = lastRowLog + 1
        Err.Clear
        On Error GoTo 0

ContinueLoop:
    Loop

    ' Add PivotTables sheet
    Set wsPivot = wbDest.Sheets.Add(After:=wsLog)
    wsPivot.Name = "PivotTables"

    ' Define data range for pivots
    Dim lastDataRow As Long
    lastDataRow = wsDest.Cells(wsDest.Rows.Count, 1).End(xlUp).Row
    Dim dataRange As Range
    Set dataRange = wsDest.Range("A1:C" & lastDataRow)

    ' Create Pivot 1: Sum Time by Case ID
    Dim pivotCache1 As PivotCache
    Dim pivotTable1 As PivotTable
    Set pivotCache1 = wbDest.PivotCaches.Create(SourceType:=xlDatabase, SourceData:=dataRange)
    Set pivotTable1 = wsPivot.PivotTables.Add(PivotCache:=pivotCache1, TableDestination:=wsPivot.Range("A3"), TableName:="Pivot_CaseID_Sum")
    With pivotTable1
        .PivotFields("Case ID").Orientation = xlRowField
        .AddDataField .PivotFields("Time taken"), "Total Time", xlSum
        On Error Resume Next
        .CalculatedFields.Add "HRS", "= 'Total Time' / 60"
        On Error GoTo 0
        .AddDataField .CalculatedFields("HRS"), "HRS", xlSum
        .DataFields("HRS").NumberFormat = "0.00"
    End With
    wsPivot.Range("A1").Value = "Pivot 1: Total Time by Case ID"

    ' Create Pivot 2: Avg Time by Description
    Dim pivotCache2 As PivotCache
    Dim pivotTable2 As PivotTable
    Set pivotCache2 = wbDest.PivotCaches.Create(SourceType:=xlDatabase, SourceData:=dataRange)
    Set pivotTable2 = wsPivot.PivotTables.Add(PivotCache:=pivotCache2, TableDestination:=wsPivot.Range("G3"), TableName:="Pivot_Description_Avg")
    With pivotTable2
        .PivotFields("Description").Orientation = xlRowField
        .AddDataField .PivotFields("Time taken"), "Average Time", xlAverage
        On Error Resume Next
        .CalculatedFields.Add "HRS", "= 'Average Time' / 60"
        On Error GoTo 0
        .AddDataField .CalculatedFields("HRS"), "HRS", xlSum
        .DataFields("HRS").NumberFormat = "0.00"
    End With
    wsPivot.Range("G1").Value = "Pivot 2: Average Time by Description"

    Application.ScreenUpdating = True
    Application.DisplayAlerts = True

    ' Save the consolidated workbook in the same folder
    wbDest.SaveAs folderPath & "Consolidated.xlsx"
    wbDest.Close SaveChanges:=False

    MsgBox "Consolidation complete! File saved as 'Consolidated.xlsx' in the selected folder.", vbInformation
End Sub
