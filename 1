' Code Generated by Sidekick is for learning and experimentation purposes only.
Sub ConsolidateExcelFiles_WithErrorLog()
    Dim folderPath As String
    Dim fileName As String
    Dim wbSource As Workbook
    Dim wsSource As Worksheet
    Dim wbDest As Workbook
    Dim wsDest As Worksheet
    Dim wsLog As Worksheet
    Dim lastRowDest As Long
    Dim lastRowLog As Long
    Dim i As Long
    Dim caseID As String
    Dim description As String
    Dim timeTaken As Variant
    Dim errorFound As Boolean
    
    ' Prompt user to select folder
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with Excel Files"
        If .Show = -1 Then
            folderPath = .SelectedItems(1) & "\"
        Else
            Exit Sub
        End If
    End With
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Create new workbook for consolidation
    Set wbDest = Workbooks.Add
    Set wsDest = wbDest.Sheets(1)
    wsDest.Name = "Consolidated"
    ' Add error log sheet
    Set wsLog = wbDest.Sheets.Add(After:=wsDest)
    wsLog.Name = "Error Log"
    wsLog.Range("A1:B1").Value = Array("File Name", "Error Description")
    lastRowDest = 2
    lastRowLog = 2
    
    ' Loop through all .xlsx files in the folder
    fileName = Dir(folderPath & "*.xlsx")
    Do While fileName <> ""
        If Left(fileName, 2) <> "~$" Then
            errorFound = False
            On Error GoTo FileOpenError
            Set wbSource = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
            Set wsSource = wbSource.Sheets(1) ' Always Sheet1
            
            caseID = wsSource.Range("B1").Value
            If Trim(caseID) = "" Then
                wsLog.Cells(lastRowLog, 1).Value = fileName
                wsLog.Cells(lastRowLog, 2).Value = "Missing Case ID in B1"
                lastRowLog = lastRowLog + 1
                errorFound = True
            End If
            
            For i = 4 To 27 ' F4:F27
                On Error GoTo CellError
                timeTaken = wsSource.Cells(i, 6).Value ' Column F
                If IsError(timeTaken) Then
                    wsLog.Cells(lastRowLog, 1).Value = fileName
                    wsLog.Cells(lastRowLog, 2).Value = "Error in cell F" & i
                    lastRowLog = lastRowLog + 1
                    errorFound = True
                ElseIf IsNumeric(timeTaken) And timeTaken > 0 And Not errorFound Then
                    description = wsSource.Cells(i, 1).Value ' Column A
                    wsDest.Cells(lastRowDest, 1).Value = caseID
                    wsDest.Cells(lastRowDest, 2).Value = description
                    wsDest.Cells(lastRowDest, 3).Value = timeTaken
                    lastRowDest = lastRowDest + 1
                End If
                On Error GoTo 0
            Next i
            
            wbSource.Close SaveChanges:=False
        End If
        fileName = Dir
        Continue Do
FileOpenError:
        wsLog.Cells(lastRowLog, 1).Value = fileName
        wsLog.Cells(lastRowLog, 2).Value = "Could not open file or missing Sheet1"
        lastRowLog = lastRowLog + 1
        On Error GoTo 0
        Resume Next
CellError:
        wsLog.Cells(lastRowLog, 1).Value = fileName
        wsLog.Cells(lastRowLog, 2).Value = "Error reading cell F" & i
        lastRowLog = lastRowLog + 1
        On Error GoTo 0
        Resume Next
    Loop
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    ' Save the consolidated workbook in the same folder
    wbDest.SaveAs folderPath & "Consolidated.xlsx"
    wbDest.Close SaveChanges:=False
    
    MsgBox "Consolidation complete! File saved as 'Consolidated.xlsx' in the selected folder.", vbInformation
End Sub
